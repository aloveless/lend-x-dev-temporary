<!DOCTYPE html>
<head lang="en">
    <title>DAPP | Lend-X</title>
    <base href="http://lend-x.io/">
    <meta charset="utf-8">
    <meta author="lend-x.io">
    <meta description="Lend-X Protocol DAPP">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script>
        if (typeof window.web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:7545"));
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.40/css/uikit.min.css">
    <link rel="stylesheet" href="http://lend-x.io/assets/css/datetimepicker.min.css">
    <link rel="stylesheet" href="http://lend-x.io/assets/css/app.css">

</head>
<body>
    <div class="uk-container uk-container-expand">
        <nav class="uk-navbar-container uk-navbar-transparent uk-navbar">
            <div class="uk-navbar-left">
                <a class="uk-navbar-item" href="/index"><img class="uk-logo" src="/assets/img/logo-color.png" /></a>
            </div>
            <div class="uk-navbar-center">
                <div id="provider"></div> 
                <div id="web3_version"></div>
            </div>
            <div class="uk-navbar-right">
                <ul class="uk-navbar-nav uk-visible@m">
                    <li>
                        <a uk-icon="icon: credit-card; ratio: 1.5" href="#" class="uk-icon"></a>
                        <div class="uk-navbar-dropdown uk-dropdown uk-width-auto" uk-dropdown="offset: 0;delay-hide:100;">
                            <label>Send Tokens</label>
                            <div class="uk-dropdown-grid" uk-grid>
                                <div>
                                    <select id="token_transfer" class="uk-select uk-width-auto"></select><br>
                                    <input id="token_transfer_recipient" class="uk-input" type="text" placeholder="Recipient" />
                                    <input id="token_transfer_amount" class="uk-input uk-width-1-2" type="text" placeholder="Amount" />
                                    <button id="send_token_transfer" class="uk-button uk-button-primary uk-float-right">Send</button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li>
                        <a uk-icon="icon: cog; ratio: 1.5" href="#" class="uk-icon"></a>
                        <div class="uk-navbar-dropdown uk-dropdown uk-width-auto" uk-dropdown="offset: 0;delay-hide:100;">
                            <label>Timezone</label>
                            <div class="uk-width-1-1@s">
                                <select id="timezone" class="uk-select">
                                    <option value="America/Los_Angeles">America/Los_Angeles</option>
                                    <option value="America/Denver">America/Denver</option>
                                    <option value="America/Chicago">America/Chicago</option>
                                    <option value="America/New_York">America/New_York</option>
                                </select>
                            </div>
                        </div>
                    </li>
                    <li>
                      <a uk-icon="icon: user; ratio: 1.5" href="#" class="uk-icon"></a>
                      <div class="uk-navbar-dropdown uk-dropdown uk-width-auto" uk-dropdown="offset: 0;delay-hide:100;">
                        <ul id="address_select" class="uk-nav uk-navbar-dropdown-nav">
                            <!-- account list -->
                        </ul>
                      </div>
                    </li>
                </ul>
                <a href="#offcanvas" class="uk-navbar-toggle uk-hidden@m" uk-toggle=""><span uk-navbar-toggle-icon="" class="uk-navbar-toggle-icon uk-icon"></span></a>
            </div>
        </nav>
    </div>


    <div class="uk-section" style="background: #2B89CA;">
      <div class="uk-container uk-container-expand">
        <div class="uk-grid uk-grid-large uk-grid-stack" uk-grid="">
          <div class="uk-width-1-2@s uk-dark uk-first-column">

            <div class="uk-card uk-card-default">
                <div class="uk-card-header">
                    <div class="uk-grid-small uk-flex-middle" uk-grid>
                        <div class="uk-width-auto"><img class="uk-border-circle" width="40" height="40" src="/assets/img/logo-color.png"></div>
                        <div class="uk-width-expand">
                            <h3 class="uk-card-title uk-margin-remove-bottom">Lend-X Protocol <span uk-icon="icon: info" uk-tooltip="Version 0.1.0"></span></h3>
                            <!-- protocol address -->
                            <p id="protocol_address" class="uk-margin-remove-top uk-text-small"></p>
                        </div>
                    </div>
                </div>
                <div class="uk-card-body">
                    <h5>Protocol Token Info</h5>
                    <div id="protocol_token_name">Name: </div>
                    <div id="protocol_token_symbol">Symbol: </div>
                    <div id="protocol_token_decimals">Decimals: </div>
                    <div id="protocol_token_supply">Total Supply: </div>
                    <div id="protocol_lendee_balance">Your Balance: </div>
                </div>
                <div class="uk-card-footer">
                    <button class="uk-button uk-button-default" uk-toggle="target: #debt_inquiry;">New Loan</button>
                </div>
            </div>


          </div>
          <div class="uk-width-1-2@s uk-dark">
            <div class="uk-card uk-card-default">
                <div class="uk-card-body">
                    <ul class="uk-tab uk-child-width-expand" uk-tab>
                        <li class="uk-active"><a href="#">Market</a></li>
                        <li><a href="#">Payable</a></li>
                        <li><a href="#">Receivable</a></li>
                        <li><a href="#">Events</a></li>
                    </ul>
                    <div class="uk-switcher uk-margin">
                        <div>
                            <h5>Watch List</h5>
                            <ul id="watchlist_data" class="uk-list uk-list-divider uk-text-small" uk-sortable="handle: li; group: market; cls-empty: uk-placeholder">

                            </ul>
                            <div class="uk-divider-icon"></div>
                            <h5>All Market</h5>
                            <ul id="market_data" class="uk-list uk-list-striped uk-text-small" uk-sortable="handle: li; group: market;">

                            </ul>
                        </div>
                        <div></div>
                        <div></div>
                        <div>
                            <ul id="logs" class="uk-list uk-list-divider">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- Loan Inquiry Modal -->
<div id="debt_inquiry" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <div  uk-switcher>
            <button class="uk-button uk-button-default">Loan</button>
            <button class="uk-button uk-button-default">Terms</button>
            <button class="uk-button uk-button-default">Guarantor</button>
            <button class="uk-button uk-button-default">Agent</button>
        </div>
        <div class="uk-divider-icon"></div>
        <div class="uk-switcher uk-margin">
            <div>
                <form id="debt_inquiry_data" class="uk-grid-small" uk-grid>
                    <div class="uk-width-1-1@s"><label class="uk-form-label">Lender</label><input class="uk-input" type="text" name="lender" placeholder="Address"></div>
                    <div class="uk-width-1-2@s"><label class="uk-form-label">Principal Token</label><select id="principalToken" class="uk-select" name="principalToken"></select></div>
                    <div class="uk-width-1-2@s"><label class="uk-form-label">Principal Amount</label><input class="uk-input" type="text" name="principalAmount" placeholder="Amount"></div>
                    <div class="uk-width-1-2@s"><label class="uk-form-label">Loan Start</label><input class="uk-input" type="text" name="loanStart" placeholder="Unix Timestamp" data-field="datetime"></div>
                </form>
                <hr />
                <p class="uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                    <button id="lendee_approvals_modal_trigger" class="uk-button uk-button-primary" type="button">Allowances <span uk-icon="icon: info" uk-tooltip="Send transaction to allow protocol to transfer fees, principal &amp; estimated interest on your behalf"></span></button>
                    <button id="lendee_sign_debt_request" class="uk-button uk-button-primary" type="button">Sign</button>
                </p>
            </div>

            <!-- Loan Terms Modal -->
            <div id="terms_message">
                <div>
                    <form id="terms_data" class="uk-grid-small" uk-grid>
                        <div class="uk-width-1-1@s"><label class="uk-form-label">Underwriter</label><input class="uk-input" type="text" name="underwriter" placeholder="Address"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Origination Fee</label><input class="uk-input" type="text" name="originationFee" placeholder="Amount (Lend-X)"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Loan Term (<span id="loan_term_translation"></span>)</label><input id="loan_term" class="uk-input" type="text" name="loanTerm" placeholder="# of Blocks"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Periodic Interest Rate (<span id="periodic_interest_rate_percent"></span>)</label><input id="periodic_interest_rate" class="uk-input" type="text" name="periodicInterestRate" placeholder=".043"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Payment Amount</label><input class="uk-input" type="text" name="paymentAmount" placeholder="Amount (Principal Token)"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Payment Interval (<span id="payment_interval_translation"></span>)</label><input id="payment_interval" class="uk-input" type="text" name="paymentInterval" placeholder="# of Blocks"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Late Fee</label><input class="uk-input" type="text" name="lateFee" placeholder="Amount (Principal Token)"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Collateral Token</label><input class="uk-input" type="text" name="collateralToken" placeholder="Address"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Collateral Amount</label><input class="uk-input" type="text" name="collateralAmount" placeholder="Amount"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Default Period (<span id="default_period_translation"></span>)</label><input id="default_period" class="uk-input" type="text" name="defaultPeriod" placeholder="# of Blocks"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Expires</label><input class="uk-input" type="text" name="expires" placeholder="Unix Timestamp" data-field="datetime"></div>
                    </form>
                    <hr />
                    <p class="uk-text-left">
                        
                    </p>
                </div>
            </div>

            <!-- Loan Guarantor Modal -->
            <div id="guarantor_message">
                <div>
                    <form id="guarantor_data" class="uk-grid-small" uk-grid>
                        <div class="uk-width-1-1@s"><label class="uk-form-label">Guarantor</label><input class="uk-input" type="text" name="guarantor" placeholder="Address"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Guarantor Fee</label><input class="uk-input" type="text" name="guarantorFee" placeholder="Amount (Lend-X)"></div>
                    </form>
                    <hr />
                    <p class="uk-text-left">
                        
                    </p>
                </div>
            </div>

            <!-- Agent Fees Modal -->
            <div id="agent_fees_message">
                <div>
                    <form id="agent_data" class="uk-grid-small" uk-grid>
                        <div class="uk-width-1-1@s"><label class="uk-form-label">Agent</label><input class="uk-input" type="text" name="agent" placeholder="Address"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Lendee Agent Fee</label><input class="uk-input" type="text" name="lendeeAgentFee" placeholder="Amount (Lend-X)"></div>
                        <div class="uk-width-1-2@s"><label class="uk-form-label">Lender Agent Fee</label><input class="uk-input" type="text" name="lenderAgentFee" placeholder="Amount (Lend-X)"></div>
                    </form>
                    <hr />
                    <p class="uk-text-left">
                        
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Debt Request Data Modal -->
<div id="debt_request_message" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h4>Message Data</h4>
        </div>
        <div class="uk-modal-body">
            <ul id="debt_request_data" class="uk-list uk-list-striped uk-text-small uk-text-break">
            </ul>
        </div>
    </div>
</div>

<!-- Lendee Approvals Modal -->
<div id="lendee_approvals_modal" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header"><h4>Minimum Lendee Allowances</h4></div>
        <div class="uk-modal-body">
            <ul id="lendee_approvals_data" class="uk-list uk-list-striped uk-text-small">
            </ul>
            <hr />
            <p class="uk-text-right">
                <a href="#debt_inquiry" class="uk-button uk-button-default" uk-toggle>Back</a>
                <button id="lendee_submit_approvals" class="uk-button uk-button-primary" type="button">Submit Approvals</button>
            </p>
        </div>
    </div>
</div>

<!-- Lender Approvals Modal -->
<div id="lender_approvals_modal" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header"><h4>Minimum Lender Allowances</h4></div>
        <div class="uk-modal-body">
            <ul id="lender_approvals_data" class="uk-list uk-list-striped uk-text-small">
            </ul>
            <hr />
            <p class="uk-text-right">
                <a href="#process_loan_modal" class="uk-button uk-button-default" uk-toggle>Back</a>
                <button id="lender_submit_approvals" class="uk-button uk-button-primary" type="button">Submit Approvals</button>
            </p>
        </div>
    </div>
</div>

<!-- Process Loan Modal -->
<div id="process_loan_modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h4>Lend Tokens</h4>
        </div>
        <div class="uk-modal-body">
            <div class="uk-grid-small" uk-grid>
                <div class="uk-width-1-2">
                    <ul id="process_loan" class="uk-list uk-text-small uk-text-break">
                    </ul>
                </div>
                <div class="uk-width-1-2">
                    <form id="lender_data" class="uk-grid-small" uk-grid>
                        <div class="uk-width-1-1@s"><label class="uk-form-label">Amount To Lend</label><input class="uk-input" type="text" name="amountToLend" placeholder="Amount (Principal Token)"></div>
                        <div class="uk-width-1-1@s"><label class="uk-form-label">Allow Partial Loan </label><input class="uk-checkbox" type="checkbox" name="lenderLoanOptions" value="allowPartialLoan" /></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="uk-modal-footer uk-text-right">
            <button id="lender_approvals_modal_trigger" class="uk-button uk-button-primary" type="button">Allowances <span uk-icon="icon: info" uk-tooltip="Send transaction to allow protocol to transfer fees &amp; principal on your behalf"></span></button>
            <button id="lender_submit_debt_request_call_locally" class="uk-button uk-button-primary" type="button">Simulate Locally <span uk-icon="icon: info" uk-tooltip="Run transaction on local node only to estimate outcome without spending gas or changing state"></span></button>
            <button id="lender_submit_debt_request" class="uk-button uk-button-primary" type="button">Process Loan <span uk-icon="icon: info" uk-tooltip="Broadcast transaction to blockchain"></span></button>
        </div>
    </div>
</div>

<div id="DateTimeBox"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.40/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.40/js/uikit-icons.min.js"></script>
    <script type="text/javascript" src="http://lend-x.io/assets/js/jquery.number.min.js"></script>
    <script type="text/javascript" src="http://lend-x.io/assets/js/datetimepicker.min.js"></script>
    <script type="text/javascript" src="http://lend-x.io/assets/js/jquery.serializejson.min.js"></script>
    <script type="text/javascript" src="http://lend-x.io/assets/js/moment.min.js"></script>
    <script>

        web3.eth.defaultAccount = web3.eth.accounts[0];

        //Contract ABIs
        var erc20Contract = web3.eth.contract([{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balances","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"_totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"address"}],"name":"allowed","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_owner","type":"address"},{"indexed":true,"name":"_spender","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Approval","type":"event"}]);
        var lendContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_requestID","type":"bytes32"}],"name":"approveCreditLineOffer","outputs":[{"name":"approveOfferAmount","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_loanAddresses","type":"address[8]"},{"name":"_loanValues","type":"uint256[15]"},{"name":"_amountToLend","type":"uint256"},{"name":"_lendeeSig","type":"bytes"},{"name":"_underwriterSig","type":"bytes"},{"name":"_guarantorSig","type":"bytes"},{"name":"_lenderLoanOptions","type":"bool[1]"}],"name":"submitDebtAgreement","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"GAS_LIMIT","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_token","type":"address"},{"name":"_owner","type":"address"}],"name":"getAllowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"deprecated","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"protocolToken","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"unlockContract","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_supercededBy","type":"address"}],"name":"deprecateContract","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"debtHash","type":"bytes32"},{"name":"amountToForgive","type":"uint256"}],"name":"forgiveDebt","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"debtHash","type":"bytes32"}],"name":"getPrincipal","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"debtHash","type":"bytes32"}],"name":"getOutstandingDebt","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"lockContract","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_loanAddresses","type":"address[8]"},{"name":"_loanValues","type":"uint256[15]"}],"name":"getDebtHash","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[{"name":"_requestID","type":"bytes32"},{"name":"_newOwner","type":"uint256"}],"name":"transferDebtOwnership","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_requestor","type":"address"}],"name":"getInterestAccrued","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"externalStorage","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_signer","type":"address"},{"name":"_debtHash","type":"bytes32"},{"name":"_sig","type":"bytes"}],"name":"validSignature","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"numerator","type":"uint256"},{"name":"denominator","type":"uint256"},{"name":"target","type":"uint256"}],"name":"getPartialAmount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":true,"inputs":[],"name":"tokenRegistry","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"paymentHandler","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"locked","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_token","type":"address"},{"name":"_owner","type":"address"}],"name":"getBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"initiateSecondaryDebtSale","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"VERSION","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_protocolToken","type":"address"},{"name":"_storage","type":"address"},{"name":"_paymentHandler","type":"address"},{"name":"_tokenRegistry","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"output","type":"uint256"}],"name":"LogTestValue","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"errorCode","type":"uint8"},{"indexed":true,"name":"debtHash","type":"bytes32"}],"name":"LogError","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"supercededBy","type":"address"}],"name":"DeprecatedEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"status","type":"bool"}],"name":"LockedEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"lendee","type":"address"},{"indexed":true,"name":"lender","type":"address"},{"indexed":false,"name":"agent","type":"address"},{"indexed":false,"name":"underwriter","type":"address"},{"indexed":false,"name":"lenderAmount","type":"uint256"},{"indexed":false,"name":"remaining","type":"uint256"}],"name":"DebtAgreementEvent","type":"event"}]);

        //Contract Objects
        protocolToken = erc20Contract.at('0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f');
        lendx = lendContract.at('0x9f544a3fc3d1045e6ec49d4ecef6dcd700457165');
        paymentHandler = '0xb9b7e0cb2edf5ea031c8b297a5a1fa20379b6a0a';

        tokenRegistry = [
            '0x2c2b9c9a4a25e24b174f26114e8926a9f2128fe4',
            '0x9fbda871d559710256a2502a2517b794b482db40',
            '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f'
        ];

        $(function(){
            $("#DateTimeBox").DateTimePicker({dateTimeFormat: 'MM-dd-yyyy hh:mm'});
            $('#periodic_interest_rate').number(true, 3);
            $('#periodic_interest_rate').keyup(function(){
                $('#periodic_interest_rate_percent').text($.number($(this).val()/100, 5));
            });
            $('#loan_term, #payment_interval, #default_period').keyup(function(){
                var secondsPerBlockMined = 14;
                var seconds = $(this).val()*secondsPerBlockMined;
                var days = seconds/86400;
                $('#'+$(this).attr('id')+'_translation').text($.number(days, 2)+' days');
            });

            if(!web3.isConnected()){
                console.log('Node Not Currently Connected');
                // show some dialog to ask the user to start a node
            } else {
                console.log('Node Connected');
                // start web3 filters, calls, etc
            }

            //Account Balances
            $.each(web3.eth.accounts, function(key, value){
                web3.eth.getBalance(web3.eth.accounts[key], function(err, res){
                    var balance = String(web3.fromWei(res,'ether')); 
                    web3.eth.getTransactionCount(web3.eth.accounts[key], function(err, res){
                        var txCount = res;
                        var nonce = web3.toHex(txCount);
                        $("#address_select").append('<li>'+(key == 0 ? '<span id="default_account" class="uk-label uk-label-warning uk-margin-small-right">Default</span>' : '')+'<span class="uk-label uk-label-success uk-inline">'+balance+'</span><a class="account_list" id="'+web3.eth.accounts[key]+'">'+web3.eth.accounts[key]+'</a><span>Tx Count ('+txCount+') Nonce ('+nonce+')</span></li><hr />');
                    });
                });
            });

            //Change Default Accounts
            $('body').on('click', '.account_list', function(e){
                e.preventDefault();
                $("#default_account").remove();
                $(this).closest('li').prepend('<span id="default_account" class="uk-label uk-label-warning uk-margin-small-right">Default</span>');
                web3.eth.defaultAccount = e.target.id;
            });

            //Protocol Contract
            $("#protocol_address").append(String(lendx.address));

            //Protocol ERC20 Token
            protocolToken.name(function(err, name){
                $("#protocol_token_name").append(name);
            });
            protocolToken.symbol(function(err, symbol){
                $("#protocol_token_symbol").append(symbol);
            });
            protocolToken.decimals(function(err, decimals){
                var divisor = new web3.BigNumber(10).toPower(decimals);
                $("#protocol_token_decimals").append(decimals.toNumber());
                protocolToken.totalSupply(function(err, totalSupply){
                    totalSupplyETH = $.number(Number(totalSupply.div(divisor)));
                    $("#protocol_token_supply").append(totalSupplyETH);
                    protocolToken.balanceOf(web3.eth.defaultAccount, function(err, erc20Balance){
                        erc20BalanceETH = $.number(Number(erc20Balance.div(divisor)), 10);
                        var percentOwned = Number(erc20Balance.div(totalSupply).mul(100));
                        $("#protocol_lendee_balance").append(erc20BalanceETH +" ("+$.number(percentOwned,5)+"%)");
                    });
                });
            });

            //Approved Lending Tokens
            $.each(tokenRegistry, function(key, value){
                var principalToken = erc20Contract.at(value);
                principalToken.name(function(err, name){
                    principalToken.symbol(function(err, symbol){
                        $("#principalToken").append('<option value="'+value+'">'+value+' ('+name+' '+symbol+')</option>');
                        $("#token_transfer").append('<option value="'+value+'">'+value+' ('+name+' '+symbol+')</option>');
                    });
                });
            });

            //web3 & provider info - Network IDs need to be updated below
            if(typeof web3.currentProvider.host === "undefined" && web3.currentProvider.isMetaMask){
                $("#provider").text('MetaMask (provider) |');
            } else {
                $("#provider").text(web3.currentProvider.host +' (provider) |');
            }
            $("#web3_version").text("| "+ web3.version.api +" (web3 version)");

            web3.version.getNetwork(function(err, networkID){
                switch (networkID) {
                    case "1":
                      //remove provider and show error so can only be used on test nets or locally until ready
                      console.log('This is mainnet');
                      break
                    case "2":
                      console.log('This is the deprecated Morden test network.');
                      break
                    case "3":
                      console.log('This is the ropsten test network.');
                      break
                    case "4":
                      console.log('This is the Rinkeby test network.');
                      break
                    case "42":
                      console.log('This is the Kovan test network.');
                      break
                    default:
                      console.log('Network ID: '+networkID);
                  }
            });

            //Watch Protocol Events
            var LogTestValue = lendx.LogTestValue({}, {fromBlock: 0, toBlock: 'latest'});
            LogTestValue.watch(function(err, res){
                $("#logs").prepend('<li>'+res.event+' ('+res.type+') '+web3.fromWei(res.args.output,'ether')+'</li>');
            });
            var DebtAgreementEvent = lendx.DebtAgreementEvent({}, {fromBlock: 0, toBlock: 'latest'});
            DebtAgreementEvent.watch(function(err, res){
                console.log(res);
                $("#logs").prepend('<li>'+res.event+' ('+res.type+') '+web3.fromWei(res.args.output,'ether')+'</li>');
            });
            var LogError = lendx.LogError({}, {fromBlock: 0, toBlock: 'latest'});
            LogError.watch(function(err, res){
               if (!err){
                    // console.log(res);
                    var errorCode = [
                        "REQUEST_EXPIRED",
                        "LOAN_FILLED",
                        "ROUNDING_ERROR_TOO_LARGE",
                        "INSUFFICIENT_BALANCE_OR_ALLOWANCE",
                        "lENDER_PARTIAL_LOAN_NOT_ALLOWABLE"
                    ];
                    $("#logs").prepend('<li>'+res.event+' ('+res.type+') '+errorCode[String(res.args.errorCode)]+'</li>');
                }
            });
            //ERC20 Transfer
            var Transfer = erc20Contract.at('0xf426505ac145abe033fe77c666840063757be9cd').Transfer({}, {fromBlock: 0, toBlock: 'latest'});
            Transfer.watch(function(err, res){
                $("#logs").prepend('<li>'+res.event+' ('+res.type+') '+web3.fromWei(res.args._value,'ether')+'</li>');
            });

            //Watch Transactions
            // var txFilter = web3.eth.filter('latest');
            // txFilter.watch(function(err, blockHash){
            //     if (!err) {
            //         var block = web3.eth.getBlock(blockHash, true);        
            //         if (block.transactions.length > 0) {
            //             for(i = 0; i < block.transactions.length; i++){
            //                 if(block.transactions[i].to == lendx.address){
            //                     web3.eth.getTransactionReceipt(block.transactions[i].hash, function(err, txReceipt){
            //                         console.log('Block #: '+txReceipt.blockNumber);
            //                         console.log(txReceipt);
            //                         console.log((txReceipt.status == '0x00' ? 'error' : 'valid'));
            //                     });
            //                 }
            //             }
            //         }
            //     } else {
            //         console.log('txFilter Error: '+err);
            //     }
            // });


            debtRequests = {};

            $("#lendee_sign_debt_request").on('click', function(){
                var debtRequest = {};
                var debtInquiry = {};
                var debtTerms = {};
                var debtGuarantor = {};
                var debtAgent = {};

                var formInquiryData = $("#debt_inquiry_data").serializeJSON();
                var formTermsData = $("#terms_data").serializeJSON();
                var formGuarantorData = $("#guarantor_data").serializeJSON();
                var formAgentData = $("#agent_data").serializeJSON();

                //Inquiry
                debtInquiry.protocolAddress = lendx.address;
                debtInquiry.lendee = web3.eth.defaultAccount;
                debtInquiry.lender = (web3.isAddress(formInquiryData.lender) ? formInquiryData.lender : "0x0000000000000000000000000000000000000000");
                debtInquiry.principalToken = formInquiryData.principalToken;
                debtInquiry.principalAmount = (formInquiryData.principalAmount ? web3.toWei(formInquiryData.principalAmount.replace(/,/g , ''), 'ether') : 0);
                debtInquiry.loanStart = (moment(formInquiryData.loanStart, 'MM-DD-YYYY HH:mm', true).isValid() ? moment.tz(formInquiryData.loanStart, 'MM-DD-YYYY HH:mm', true, $("#timezone").val()).unix() : 0);
                debtInquiry.salt = pseudoRandomNumber();
                //Terms
                debtTerms.underwriter = (web3.isAddress(formTermsData.underwriter) ? formTermsData.underwriter : "0x0000000000000000000000000000000000000000");
                debtTerms.originationFee = (formTermsData.originationFee ? web3.toWei(formTermsData.originationFee.replace(/,/g , ''), 'ether') : 0);
                debtTerms.loanTerm = (formTermsData.loanTerm ? parseInt(formTermsData.loanTerm) : 0);
                debtTerms.periodicInterestRate = (formTermsData.periodicInterestRate > 0 ? parseInt(formTermsData.periodicInterestRate*1000) : 0);
                debtTerms.paymentAmount = (formTermsData.paymentAmount ? web3.toWei(formTermsData.paymentAmount.replace(/,/g , ''), 'ether') : 0);
                debtTerms.paymentInterval = (formTermsData.paymentInterval ? parseInt(formTermsData.paymentInterval) : 0);
                debtTerms.lateFee = (formTermsData.lateFee ? web3.toWei(formTermsData.lateFee.replace(/,/g , ''), 'ether') : 0);
                debtTerms.collateralToken = (web3.isAddress(formTermsData.collateralToken) ? formTermsData.collateralToken : "0x0000000000000000000000000000000000000000");
                debtTerms.collateralAmount = (formTermsData.collateralAmount ? web3.toWei(formTermsData.collateralAmount.replace(/,/g , ''), 'ether') : 0);
                debtTerms.defaultPeriod = (formTermsData.defaultPeriod ? parseInt(formTermsData.defaultPeriod) : 0);
                debtTerms.expires = (moment(formTermsData.expires, 'MM-DD-YYYY HH:mm', true).isValid() ? moment.tz(formTermsData.expires, 'MM-DD-YYYY HH:mm', true, $("#timezone").val()).unix() : 0);
                //Guarantor
                debtGuarantor.guarantor =  (web3.isAddress(formGuarantorData.guarantor) ? formGuarantorData.guarantor : "0x0000000000000000000000000000000000000000");
                debtGuarantor.guarantorFee =  (formGuarantorData.guarantorFee ? web3.toWei(formGuarantorData.guarantorFee.replace(/,/g , ''), 'ether') : 0);
                //Agent
                debtAgent.agent = (web3.isAddress(formAgentData.agent) ? formAgentData.agent : "0x0000000000000000000000000000000000000000");
                debtAgent.lendeeAgentFee =  (formAgentData.lendeeAgentFee ? web3.toWei(formAgentData.lendeeAgentFee.replace(/,/g , ''), 'ether') : 0);
                debtAgent.lenderAgentFee =  (formAgentData.lenderAgentFee ? web3.toWei(formAgentData.lenderAgentFee.replace(/,/g , ''), 'ether') : 0);

                //Create Debt Request Object
                debtRequest = Object.assign(debtInquiry, debtTerms, debtGuarantor, debtAgent);

                //Put Debt Request In Arrays for Contract
                var debtRequestArgs = processDebtRequestArgsForContract(debtRequest);
                console.log(debtRequestArgs);

                lendx.getDebtHash(debtRequestArgs.loanAddresses, debtRequestArgs.loanValues, function(err, hash){
                    if(!err){
                        console.log('Debt Hash: '+hash);
                        //web3.personal.sign(hash, web3.eth.accounts[0], function(err, sig){
                        web3.eth.sign(web3.eth.defaultAccount, hash, function(err, sig){
                            if(!err){
                                lendx.validSignature(web3.eth.defaultAccount, hash, sig, function(err, res){
                                    if(!err){
                                        if(res){
                                            debtInquiry.lendeeSig = String(sig);

                                            var principalToken = erc20Contract.at(debtInquiry.principalToken);
                                            principalToken.symbol(function(err, symbol){
                                                $("#market_data").prepend('<li><a id="'+String(hash)+'" href="debt_request_data">'+symbol+' - '+web3.fromWei(debtInquiry.principalAmount,'ether')+'</a><a id="'+String(hash)+'" href="process_loan" class="uk-button uk-button-default uk-button-small uk-margin-left uk-float-right">Lend</a></li>');
                                            });
                                            debtRequests[String(hash)] = debtRequest;
                                        } else {
                                            console.log('ECRecovery Invalid');
                                        }
                                    } else {
                                        console.log('ECRecovery Error:'+err);
                                    }
                                });
                            } else {
                                console.log('Sig Error:'+err);
                            }
                        });
                    } else {
                        console.log('Hash Error: '+err);
                    }
                });

                //var debugCall = '{"jsonrpc":"2.0","method":"debug_traceTransaction","params":["'+web3.eth.defaultAccount+'", "'+debtRequestHash+'"],"id":'+web3.eth.getTransactionCount(web3.eth.defaultAccount)+'}';
                // $.post( "HTTP://127.0.0.1:7545", serialize , function(data) {
                    //$("#events").append("Message Hash:<br>"+hash+"<br>Length: "+hash.length+"<br><br>Signature Hash:<br>"+ data.result+"<br>Length: "+data.result.length);
                    // unHex = data.result.substring(2);
                    // var bytes_array = [];
                    // bytes_array = unHex.match(/[\s\S]{1,2}/g) || [];
                    //$("#verify").val('"'+hash+'", ["'+bytes_array+'"]');
                    //var recovery = ecrecovery.recover(hash, data.result);
                // }, "json");
            });
            
            $("body").on('click','ul#market_data > li > a, ul#watchlist_data > li > a', function(e){
                e.preventDefault();
                switch($(this).attr('href')){
                    case 'debt_request_data':
                        $("#debt_request_data").empty();
                        $.each(debtRequests[e.target.id], function(key, value){
                            switch(key){
                                case 'periodicInterestRate':
                                    $("#debt_request_data").append('<li>'+key+': '+value+' ('+$.number(value/1000,3)+')</li>');
                                break;
                                default:
                                    $("#debt_request_data").append('<li>'+key+': '+value+'</li>');
                                break;
                            }
                        });
                        UIkit.modal("#debt_request_message").show();
                    break;
                    case 'process_loan':
                        $("#process_loan").empty();
                        var debtRequest = debtRequests[e.target.id];
                        $("#process_loan").append('<li>Lendee: '+debtRequest.lendee+'</li>');
                        $("#process_loan").append('<li>Principal Amount: '+web3.fromWei(debtRequest.principalAmount,'ether')+'</li>');
                        $("#process_loan").append('<li>Expires: '+moment.unix(debtRequest.expires).tz($("#timezone").val()).format('MM-DD-YYYY HH:mm')+'</li>');

                        //attach html5 data-attribute to Lender Submit Buttons
                        $("#lender_approvals_modal_trigger, #lender_submit_approvals, #lender_submit_debt_request, #lender_submit_debt_request_call_locally").data("target",e.target.id);
                        UIkit.modal("#process_loan_modal").show();
                    break;
                    default:
                        console.log('Error');
                    break;
                }
            });

        });

        $("#lendee_approvals_modal_trigger, #lender_approvals_modal_trigger").on('click', function(){
            switch($(this).attr('id')){
                case 'lendee_approvals_modal_trigger':
                    getLendeeAllowances(function(allowances){
                        $("#lendee_approvals_data").empty();
                        $("#lendee_approvals_data").append('<li># of Payments: '+Math.ceil(allowances.numPayments)+'</li>');
                        $("#lendee_approvals_data").append('<li>Total Repayment: '+allowances.totalRepayment+'</li>');
                        $("#lendee_approvals_data").append('<li>Total Protocol Fees: '+allowances.protocolFees+'</li>');
                        UIkit.modal("#lendee_approvals_modal").show();
                    });
                break;
                case 'lender_approvals_modal_trigger':
                    getLenderAllowances(function(allowances){
                        $("#lender_approvals_data").empty();
                        $("#lender_approvals_data").append('<li>Loan Amount: '+allowances.amountToLend+'</li>');
                        $("#lender_approvals_data").append('<li>Total Protocol Fees: '+allowances.protocolFees+'</li><div class="uk-divider-icon"></div>');
                        $("#lender_approvals_data").append('<li>Current Principal Token Balance: '+allowances.currentPrincipalTokenBalance+'</li>');
                        $("#lender_approvals_data").append('<li>Current Principal Token Allowance: '+allowances.currentPrincipalTokenAllowance+'</li>');
                        $("#lender_approvals_data").append('<li>Current Protocol Token Balance: '+allowances.currentProtocolTokenBalance+'</li>');
                        $("#lender_approvals_data").append('<li>Current Protocol Token Allowance: '+allowances.currentProtocolTokenAllowance+'</li>');
                        UIkit.modal("#lender_approvals_modal").show();
                    });
                break;
            }
        });

        $("#lendee_submit_approvals, #lender_submit_approvals").on('click', function(){
            switch($(this).attr('id')){
                case 'lendee_submit_approvals':
                    getLendeeAllowances(function(allowances){
                        if(allowances.principalToken == protocolToken.address){
                            var approval = allowances.currentProtocolTokenAllowance.plus(allowances.totalRepayment.plus(allowances.protocolFees));
                            protocolToken.approve(paymentHandler, web3.toWei(approval,'ether'), function(err, tx){
                                if(!err){
                                    console.log('Transaction Promise: '+tx);
                                    UIkit.notification("Approval Sent", {pos: 'top-right', timeout: '2000'});
                                } else { console.log(JSON.stringify(err)); }
                            });
                        } else {
                            protocolToken.approve(paymentHandler, web3.toWei(allowances.currentProtocolTokenAllowance.plus(allowances.protocolFees),'ether'), function(err, tx){
                                if(!err){
                                    console.log('Transaction Promise: '+tx);
                                    erc20Contract.at(allowances.principalToken).approve(paymentHandler, web3.toWei(allowances.currentPrincipalTokenAllowance.plus(allowances.totalRepayment), 'ether'), function(err, tx){
                                        if(!err){
                                            console.log('Transaction Promise: '+tx);
                                            UIkit.notification("Approvals Sent", {pos: 'top-right', timeout: '2000'});
                                        } else { console.log(JSON.stringify(err)); }
                                    });
                                } else { console.log(JSON.stringify(err)); }
                            });
                        }
                    });
                break;
                case 'lender_submit_approvals':
                    getLenderAllowances(function(allowances){
                        if(allowances.principalToken == protocolToken.address){
                            var approval = allowances.currentProtocolTokenAllowance.plus(allowances.amountToLend.plus(allowances.protocolFees));
                            protocolToken.approve(paymentHandler, web3.toWei(approval,'ether'), function(err, tx){
                                if(!err){
                                    console.log('Transaction Promise: '+tx);
                                    UIkit.notification("Approval Sent", {pos: 'top-right', timeout: '2000'});
                                } else { console.log(JSON.stringify(err)); }
                            });
                        } else {
                            protocolToken.approve(paymentHandler, web3.toWei(allowances.currentProtocolTokenAllowance.plus(allowances.protocolFees),'ether'), function(err, tx){
                                if(!err){
                                    console.log('Transaction Promise: '+tx);
                                    erc20Contract.at(allowances.principalToken).approve(paymentHandler, web3.toWei(allowances.currentPrincipalTokenAllowance.plus(allowances.amountToLend), 'ether'), function(err, tx){
                                        if(!err){
                                            console.log('Transaction Promise: '+tx);
                                            UIkit.notification("Approvals Sent", {pos: 'top-right', timeout: '2000'});
                                        } else { console.log(JSON.stringify(err)); }
                                    });
                                } else { console.log(JSON.stringify(err)); }
                            });
                        }
                    });
                break;
            }
        });

        function getLendeeAllowances(callback){
            var allowances = {};
            var formInquiryData = $("#debt_inquiry_data").serializeJSON();
            var formTermsData = $("#terms_data").serializeJSON();
            var formGuarantorData = $("#guarantor_data").serializeJSON();
            var formAgentData = $("#agent_data").serializeJSON();

            var originationFee = (formTermsData.originationFee ? String(formTermsData.originationFee.replace(/,/g , '')) : 0);
            var guarantorFee = (formGuarantorData.guarantorFee ? String(formGuarantorData.guarantorFee.replace(/,/g , '')) : 0);
            var lendeeAgentFee = (formAgentData.lendeeAgentFee ? String(formAgentData.lendeeAgentFee.replace(/,/g , '')) : 0);
            var principalAmount = (formInquiryData.principalAmount ? String(formInquiryData.principalAmount.replace(/,/g , '')) : 0);
            var principalToken = formInquiryData.principalToken;
            var paymentAmount = (formTermsData.paymentAmount ? String(formTermsData.paymentAmount.replace(/,/g , '')) : 0);
            var periodicInterestRate = (formTermsData.periodicInterestRate ? formTermsData.periodicInterestRate.replace(/,/g , '') : 0);

            protocolToken.allowance(web3.eth.defaultAccount, paymentHandler, function(err, res){
                console.log('Current Protocol Token Allowance: '+res.toString());
                allowances.currentProtocolTokenAllowance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                erc20Contract.at(principalToken).allowance(web3.eth.defaultAccount, paymentHandler, function(err, res){
                    console.log('Current Principal Token Allowance: '+res.toString());
                    allowances.currentPrincipalTokenAllowance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                    //Fixed Payment Loan
                    //# of payments = (-1*Math.log(1-((principal/payment amount)*(periodic interest rate/100))))/Math.log(1+(periodic interest rate/100))
                    if(formTermsData.periodicInterestRate > 0){
                        //compound interest
                        allowances.numPayments = ((web3.toBigNumber(-1).mul(web3.toBigNumber(Math.log(web3.toBigNumber(1).minus(((web3.toBigNumber(principalAmount).div(web3.toBigNumber(paymentAmount))).mul(web3.toBigNumber(periodicInterestRate/100)))))))).div(web3.toBigNumber(Math.log(1+(periodicInterestRate/100)))));
                        allowances.totalRepayment = allowances.numPayments.mul(web3.toBigNumber(paymentAmount));
                        allowances.protocolFees = web3.toBigNumber(originationFee).plus(web3.toBigNumber(guarantorFee)).plus(web3.toBigNumber(lendeeAgentFee));
                        allowances.principalToken = principalToken;
                    } else {
                        //no interest
                        allowances.numPayments = web3.toBigNumber(principalAmount).div(web3.toBigNumber(paymentAmount));
                        allowances.totalRepayment = web3.toBigNumber(principalAmount);
                        allowances.protocolFees = web3.toBigNumber(originationFee).plus(web3.toBigNumber(guarantorFee)).plus(web3.toBigNumber(lendeeAgentFee));
                        allowances.principalToken = principalToken;
                    }
                    //need another condition for simple interest when the Lendee option is included
                    callback(allowances);
                });
            });
        }

        function getLenderAllowances(callback){
            var debtRequest = debtRequests[$("#lender_approvals_modal_trigger").data('target')];
            var formLenderData = $("#lender_data").serializeJSON();
            var allowances = {};

            protocolToken.allowance(web3.eth.defaultAccount, paymentHandler, function(err, res){
                allowances.currentProtocolTokenAllowance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                protocolToken.balanceOf(web3.eth.defaultAccount, function(err, res){
                    allowances.currentProtocolTokenBalance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                    erc20Contract.at(debtRequest.principalToken).allowance(web3.eth.defaultAccount, paymentHandler, function(err, res){
                        allowances.currentPrincipalTokenAllowance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                        erc20Contract.at(debtRequest.principalToken).balanceOf(web3.eth.defaultAccount, function(err, res){
                            allowances.currentPrincipalTokenBalance = web3.toBigNumber(web3.fromWei(String(res),'ether'));
                            allowances.amountToLend = web3.toBigNumber((formLenderData.amountToLend ? formLenderData.amountToLend.replace(/,/g , '') : 0));
                            allowances.protocolFees = web3.fromWei(web3.toBigNumber(debtRequest.lenderAgentFee),'ether');
                            allowances.principalToken = debtRequest.principalToken;
                            callback(allowances);
                        });
                    });
                });
            });
        }

        $("#lender_submit_debt_request, #lender_submit_debt_request_call_locally").on('click', function(){
            var formLenderData = $("#lender_data").serializeJSON();
            var amountToLend = (formLenderData.amountToLend ? web3.toWei(formLenderData.amountToLend.replace(/,/g , ''), 'ether') : 0);
            var lenderLoanOptions = [];
            lenderLoanOptions[0] = ($("input[name=lenderLoanOptions]").prop('checked') && $("input[name=lenderLoanOptions]:checked")[0].value == 'allowPartialLoan' ? true : false);
            var debtRequest = debtRequests[$(this).data('target')];
            var debtRequestArgs = processDebtRequestArgsForContract(debtRequest);

            switch($(this).attr('id')){
                case 'lender_submit_debt_request':
                    lendx.submitDebtAgreement(debtRequestArgs.loanAddresses, debtRequestArgs.loanValues, amountToLend, debtRequest.lendeeSig, '0x0', '0x0', lenderLoanOptions, {gas: 2000000}, function(err, tx){
                        if(!err){
                            console.log(tx);
                            UIkit.notification("Transaction Sent", {pos: 'top-right', timeout: '2000'});
                        } else { console.log(JSON.stringify(err)); }
                    });
                break;
                case 'lender_submit_debt_request_call_locally':
                    lendx.submitDebtAgreement.call(debtRequestArgs.loanAddresses, debtRequestArgs.loanValues, amountToLend, debtRequest.lendeeSig, '0x0', '0x0', lenderLoanOptions, {gas: 2000000}, function(err, res){
                        if(!err){
                            console.log(res);
                            UIkit.notification("Response: "+res, {pos: 'top-right', timeout: '2000'});
                        } else { console.log(JSON.stringify(err)); }
                    });
                break;
            }
        });

        function processDebtRequestArgsForContract(debtRequest){
            var res = {};
            res.loanAddresses = [
                debtRequest.protocolAddress,                //Protocol Address
                debtRequest.lendee,                         //Lendee
                debtRequest.lender,                         //Lender
                debtRequest.principalToken,                 //Principal Token
                debtRequest.underwriter,                    //Underwriter
                debtRequest.collateralToken,                //Collateral Token
                debtRequest.guarantor,                      //Guarantor
                debtRequest.agent                           //Agent
            ];
            res.loanValues = [
                debtRequest.principalAmount,                //Principal Amount
                debtRequest.loanStart,                      //Loan Start
                debtRequest.originationFee,                 //Origination Fee
                debtRequest.loanTerm,                       //Loan Term
                debtRequest.periodicInterestRate,           //Periodic Interest Rate
                debtRequest.paymentAmount,                  //Payment Amount
                debtRequest.paymentInterval,                //Payment Interval
                debtRequest.lateFee,                        //Late Fee
                debtRequest.collateralAmount,               //Collateral Amount
                debtRequest.defaultPeriod,                  //Default Period
                debtRequest.guarantorFee,                   //Guarantor Fee
                debtRequest.lendeeAgentFee,                 //Lendee Agent Fee
                debtRequest.lenderAgentFee,                 //Lender Agent Fee
                debtRequest.expires,                        //Expires
                debtRequest.salt                            //Salt
            ];
            return res;
        }

        $("#send_token_transfer").on('click', function(){
            var token = $("#token_transfer").val();
            var recipient = (web3.isAddress($("#token_transfer_recipient").val()) ? $("#token_transfer_recipient").val() : '0x0');
            var amount = ($("#token_transfer_amount").val() ? web3.toWei($("#token_transfer_amount").val().replace(/,/g , ''), 'ether') : 0);
            console.log(token);
            console.log(recipient);
            console.log(amount);
            erc20Contract.at(token).transfer(recipient, amount, function(err, tx){
                if(!err){
                    console.log(tx);
                    UIkit.notification("Transaction Sent", {pos: 'top-right', timeout: '2000'});
                } else { console.log(JSON.stringify(err)); }
            });
        });

        //Based on https://medium.com/@dazcyril/generating-cryptographic-random-state-in-javascript-in-the-browser-c538b3daae50
        //Implements Javascript Cryptography API: https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues
        //** Look into properly seeding
        function pseudoRandomNumber(seed){
            const validChars = '0123456789'; //numbers only
            let uintArray = new Uint8Array(32);
            window.crypto.getRandomValues(uintArray);
            uintArray = uintArray.map(x => validChars.charCodeAt(x % validChars.length));
            var requestSalt = String.fromCharCode.apply(null, uintArray);
            return requestSalt;
        }
    </script>

</body>
</html>
